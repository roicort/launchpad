---
type Props = {
  label?: string;
  class?: string;
  timeZone?: string;
  locale?: string;
  hour12?: boolean;
};

const {
  label = 'Local time',
  class: className = '',
  timeZone,
  locale = 'en-US',
  hour12 = true,
}: Props = Astro.props;
const classes = ['flex items-center gap-2', className].filter(Boolean).join(' ');
const clockId = `clock-${Math.random().toString(36).slice(2, 8)}`;
const formatter = new Intl.DateTimeFormat(locale, {
  hour: '2-digit',
  minute: '2-digit',
  hour12,
  timeZone,
});

const initialTime = formatter.format(new Date());
---

<div class={classes}>
  {label && <span class="text-xs uppercase tracking-[0.08em] text-subtle">{label}</span>}
  <span
    id={clockId}
    data-locale={locale}
    data-time-zone={timeZone ?? ''}
    data-hour12={hour12 ? 'true' : 'false'}
    aria-live="polite"
    class="text-sm font-semibold text-ink"
  >
    {initialTime}
  </span>
</div>

<script is:inline>
  (() => {
    const clockEl = document.getElementById('{clockId}');
    if (!clockEl) return;

    const locale = clockEl.dataset.locale || 'en-US';
    const timeZone = clockEl.dataset.timeZone || undefined;
    const hour12 = clockEl.dataset.hour12 === 'true';

    const formatter = new Intl.DateTimeFormat(locale, {
      hour: '2-digit',
      minute: '2-digit',
      hour12,
      timeZone: timeZone || undefined,
    });

    const updateClock = () => {
      clockEl.textContent = formatter.format(new Date());
    };

    updateClock();

    const now = new Date();
    const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
    setTimeout(() => {
      updateClock();
      setInterval(updateClock, 60 * 1000);
    }, msToNextMinute);
  })();
</script>
